<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Ast混淆技术 | Hanson&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="ast学习">
<meta name="author" content="
作者:&nbsp;hanson">
<link rel="canonical" href="https://hanson00.github.io/posts/technology/js%E9%80%86%E5%90%91/ast%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.845a44c8f19c77e054f472b3a0bacb3d33effea14f20590af5e97de848f8ab8b.css" integrity="sha256-hFpEyPGcd&#43;BU9HKzoLrLPTPv/qFPIFkK9el96Ej4q4s=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://hanson00.github.io/posts/imgs/66.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://hanson00.github.io/posts/imgs/favicon16x16.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://hanson00.github.io/posts/imgs/favicon32x32.ico">
<link rel="apple-touch-icon" href="https://hanson00.github.io/posts/imgs/66.jpg">
<link rel="mask-icon" href="https://hanson00.github.io/posts/imgs/66.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Ast混淆技术" />
<meta property="og:description" content="ast学习" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hanson00.github.io/posts/technology/js%E9%80%86%E5%90%91/ast%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-17T16:21:43&#43;08:00" />
<meta property="article:modified_time" content="2023-03-17T16:21:43&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ast混淆技术"/>
<meta name="twitter:description" content="ast学习"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://hanson00.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "💻技术类文章",
      "item": "https://hanson00.github.io/posts/technology/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Ast混淆技术",
      "item": "https://hanson00.github.io/posts/technology/js%E9%80%86%E5%90%91/ast%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Ast混淆技术",
  "name": "Ast混淆技术",
  "description": "ast学习",
  "keywords": [
    ""
  ],
  "articleBody": "ast技术 ast技术对爬虫工程师来说只是一种辅助工具，并不能帮我们找到核心的代码，但能够提高我们扣混淆js的效率，提高代码可读性。\n在编译原理中，编译器转换代码通常要经过三个步骤：词法分析（Lexical Analysis）、语法分析（Syntax Analysis）、代码生成（Code Generation）\n学习ast主要就是判断节点，写条件，还原代码\nast的定义 ast(Absctact Syntax Tree)，译为抽象语法树。为源代码的抽象语法结构的树状表示，树上的每个节点都表示源代码中的一种结构，这种数据结构可以类别为一个大的JSON对象。通过 AST 技术，我们面对的就不再是各种符号混杂空格而成的文本字符串，而是一个严谨规范的树形结构，我们可以通过对 AST 树节点的一系列操作，借助机器高效且精准地修改代码。\n1 2 3  下面两段js代码等价，相当于从'sm-crypto'中读取sm2模块 const sm2 = require('sm-crypto').sm2 const {sm2} = require('sm-crypto')   AST 的用途 IDE 的语法高亮、代码检查、格式化、压缩、转译等。将 ES6转化成ES5实现语法兼容\nAST插件的资源   Astexplorer.net：一个在线的AST浏览器和编辑器，可以帮助你快速创建和调试AST插件。\n  Esprima和Babel：这两个工具是用于JavaScript的解析器和转译器，可以帮助你构建JavaScript AST插件。\n  Python的ast模块：Python内置的ast模块提供了一组工具来处理Python代码的AST，可以帮助你构建Python AST插件。\n  LLVM：一个开源的编译器基础设施，提供了许多库和工具来处理AST和IR，可以帮助你构建C++等语言的AST插件。\n  学习ast参考地址：https://evilrecluse.top/Babel-traverse-api-doc/#/\n  解混淆API学习 1  var a = \"\\u0068\\u0065\\u006c\\u006c\\u006f\\u002c\\u0041\\u0053\\u0054\"   1. type: 表示当前节点的类型，我们常用的类型判断方法 t.is ****(node),就是判断当前的节点是否为某个类型。\n2. start: 表示当前节点的起始位。\n3. end: 表示当前节点的末尾。\n4. loc : 表示当前节点所在的行列位置，里面也有start与end节点，这里的start与上面的start是不同的，这里的start是表示节点所在起始的行列位。置，而end表示的是节点所在末尾的行列位置。\n5. errors:是File节点所特有的属性，可以不用理会。\n6. program:包含整个源代码，不包含注释节点。\n7. comments:源代码中所有的注释会在这里显示。\n各种常见的节点类型 fs库可以解决js的文件读写问题 读取文件\n1  xx = _fs.readFileSync('test.js',{encoding:'utf-8'})   写入文件\n1  fs.writeFile('decode.js', code, (err)={});   安装babel库  @babel/core：Babel 编译器本身，提供了 babel 的编译 API； @babel/parser：将 JavaScript 代码解析成 AST 语法树； @babel/traverse：遍历、修改 AST 语法树的各个节点； @babel/generator：将 AST 还原成 JavaScript 代码； @babel/types：判断、验证节点的类型、构建新 AST 节点等。  1  npm install @babel/core --save-dev   小试牛刀 parser的使用 1 2 3 4 5 6  const parse = require('@babel/parser') js_code = `var a = \"\\u0068\\u0065\\u006c\\u006c\\u006f\\u002c\\u0041\\u0053\\u0054\"` let astTree = parse.parse(js_code) console.log(JSON.stringify(astTree, null, '\\t'))   输出结果如下：\n和ast解混淆网站输出的结果相同\ntraverse的使用 traverse负责编写插件还原JavaScript\npath的属性 path.node:表示当前path下的node节点\npath.toString():当前路径所对应的源代码\npath.parentPath:用于获取当前path下的父path，多用于判断节点类型\npath.container:用于获取当前path下的所有兄弟节点(包括自身)\npath.type:获取当前节点类型\npath.get(''):获取path的子路径\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52  const parse = require('@babel/parser') //负责编写解混淆插件 const traverse = require('@babel/traverse').default const generator = require('@babel/generator').default js_code = `var a = \"\\u0068\\u0065\\u006c\\u006c\\u006f\\u002c\\u0041\\u0053\\u0054\"` let astTree = parse.parse(js_code) // 编写插件，还原JavaScript // traverse(astTree, { // VariableDeclaration(path){ // // path.node 表示当前节点 // console.log(path.node) // // // path.type 获取当前节点的类型 // // console.log(path.type) // // //path.toString() 获取源代码 // console.log(path.toString()) // // //下面两个语句作用相同 // console.log(path.parent) // // console.log(path.parentPath.node) // // console.log('-------------------------------') // // .get()找下一个节点 // // console.log(path.get('declarations') // } // })  //处理编码 plug = { StringLiteral(path){ path.node.extra.raw = path.node.extra.rawValue } } traverse(astTree, plug) // traverse(astTree, { // Identifier(path){ // console.log(path.node.name) // } // }) // // traverse(astTree, { // StringLiteral(path){ // console.log(path.node.value) // // } // })  let {code} = generator(astTree) console.log(code)   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const parse = require('@babel/parser') const traverse = require('@babel/traverse').default const generator = require('@babel/generator').default js_code = `var a = \"\\u0068\\u0065\\u006c\\u006c\\u006f\\u002c\\u0041\\u0053\\u0054\"` let astTree = parse.parse(js_code) let code1 = generator(astTree) console.log(code1) // `@babel/generator`：将 AST 还原成 JavaScript 代码 // {code}是从还原的代码中获取JavaScript源代码，运行代码可以自己看看 let {code} = generator(astTree) console.log('-------------------') console.log(code)   path方法 path.replaceWith:(单)节点替换函数\nreplaceWithMultiple 多节点替换函数，调用方式:\n1  path.replaceWithMultiple(ArrayNode);   replaceWithMultiple 方法需要传入一个节点数组作为参数，这个数组中的节点会被替换当前的节点。这些新节点可以是任何合法的 AST 节点，例如表达式、语句、声明等\n1  path.replaceWith(newNode);   1 2 3  !(function () { console.log('66666') })   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // 还原函数 traverse(astTree, { UnaryExpression(path) { let {argument} = path.node if (!types.isFunctionExpression(argument)) { return } let {body, id, params} = argument if (id != null || params.length != 0) { return } //`replaceWithMultiple `多节点替换函数，调用方式:  path.replaceWithMultiple(body.body); } })   evaluate()方法学习\n针对作用域和引用，直接依据引用来计算出执行结果。\n例子：navigator[\"\\x75\\x73\"+\"\\x65\\x72\"+\"\\x41\\x67\"+\"\\x65\\x6e\"+\"\\x74\"]\n例子2：\n1 2 3  function _xl(){ x = 1 + 2 + 3 +4 + 5 + 6 + 7 }   插件编写\n1 2 3 4 5 6 7  visitor2 = { \"BinaryExpression|Identifier\"(path){ const {confident,value} = path.evaluate(); confident \u0026\u0026 path.replaceInline(types.valueToNode(value)) } } traverse(_ast,visitor2)   编码类型还原\n处理前:\n1 2 3  var a = 0x25,b = 0b10001001,c = 0o123456, d = \"\\x68\\x65\\x6c\\x6c\\x6f\\x2c\\x41\\x53\\x54\", e = \"\\u0068\\u0065\\u006c\\u006c\\u006f\\u002c\\u0041\\u0053\\u0054\";   处理后:\n1  var a = 37,b = 137,c = 42798,d = \"hello,AST\",e = \"hello,AST\";   插件编写:\n1 2 3 4 5 6 7 8 9 10 11 12 13  const transform_literal = { NumericLiteral({node}) { if (node.extra \u0026\u0026 /^0[obx]/i.test(node.extra.raw)) { node.extra = undefined; } }, StringLiteral({node}) { if (node.extra \u0026\u0026 /\\\\[ux]/gi.test(node.extra.raw)) { node.extra = undefined; } }, }    通用插件\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  const constantFold = { \"BinaryExpression|UnaryExpression|ConditionalExpression\"(path) { // 防止溢出  if(path.isUnaryExpression({operator:\"-\"}) || path.isUnaryExpression({operator:\"void\"})) { return; } const {confident, value} = path.evaluate(); if (!confident) return; if (typeof value == 'number' \u0026\u0026 (!Number.isFinite(value))) { return; } path.replaceWith(types.valueToNode(value)); }, } traverse(_ast, constantFold);   fs导出与读取文件 读取文件\n1  gy = _fs.readFileSync('test.js',{encoding:'utf-8'})   写入文件\n1  fs.writeFile('decode.js', code, (err)={});   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145  const parse = require('@babel/parser') const traverse = require('@babel/traverse').default const generator = require('@babel/generator').default const fs = require('fs') const types = require('@babel/types') js_code = fs.readFileSync('encode.js', {encoding: 'utf-8'}) let astTree = parse.parse(js_code) // 处理编码 // 变量赋值还原 traverse(astTree, { // 变量赋值还原  StringLiteral(path) { path.node.extra.raw = path.node.rawValue } }) // + 拼接还原 traverse(astTree, { // + 拼接还原  BinaryExpression(path) { let {left, operator, right} = path.node; // console.log(left)  // console.log(left.value)  if (types.isNumericLiteral(left) \u0026\u0026 types.isNumericLiteral(right) \u0026\u0026 operator == \"+\") { value = left.value + right.value path.replaceWith(types.valueToNode(value)) // 进行方法替换  } if (types.isStringLiteral(left) \u0026\u0026 types.isStringLiteral(right) \u0026\u0026 operator == '+') { let value = left.value + right.value path.replaceWith(types.valueToNode(value)) } } }) // 还原函数 traverse(astTree, { UnaryExpression(path) { let {argument} = path.node if (!types.isFunctionExpression(argument)) { return } let {body, id, params} = argument if (id != null || params.length != 0) { return } //`replaceWithMultiple `多节点替换函数，调用方式:  path.replaceWithMultiple(body.body); } }) // 还原带括号的自执行方法 traverse(astTree, { UnaryExpression(path) { let {argument} = path.node // console.log(argument)  if (!types.isCallExpression(argument)) { return } // console.log(argument.callee)  let {body, id, params} = argument.callee if (id != null || params.length != 0) { return } //`replaceWithMultiple `多节点替换函数，调用方式:  path.replaceWithMultiple(body.body); } }) // 还原var arr = '3,4,0,5,1,2'['split'](',')代码有问题 // traverse(astTree, { // CallExpression(path){ // let {callee,arguments} = path.node // // object是列表的值 // let object = callee.object.value; // // console.log(object) // // //property是方法split // let property = callee.property.value; // // console.log(property) // // 逗号 // let argument = arguments[0].value; // // console.log(argument) // // //模拟执行方法 // array = property[object](argument) // path.replaceWithMultiple(types.valueToNode(array)) // } // })  // 计算结果拼接 针对作用域和引用，直接依据引用来计算出执行结果。 traverse(astTree, { \"BinaryExpression|Identifier\"(path){ const {confident,value} = path.evaluate(); confident \u0026\u0026 path.replaceInline(types.valueToNode(value)) } }) //通用插件 const constantFold = { \"BinaryExpression|UnaryExpression|ConditionalExpression\"(path) { // 防止溢出  if(path.isUnaryExpression({operator:\"-\"}) || path.isUnaryExpression({operator:\"void\"})) { return; } const {confident, value} = path.evaluate(); if (!confident) return; if (typeof value == 'number' \u0026\u0026 (!Number.isFinite(value))) { return; } path.replaceWith(types.valueToNode(value)); }, } traverse(astTree, constantFold); // 编码类型还原，处理编码和进制插件 const transform_literal = { NumericLiteral({node}) { if (node.extra \u0026\u0026 /^0[obx]/i.test(node.extra.raw)) { node.extra = undefined; } }, StringLiteral({node}) { if (node.extra \u0026\u0026 /\\\\[ux]/gi.test(node.extra.raw)) { node.extra = undefined; } }, } traverse(astTree, transform_literal); let {code} = generator(astTree) console.log('--------------------------') console.log(code) fs.writeFile('decode.js', code, (err) = { });   ",
  "wordCount" : "3100",
  "inLanguage": "en",
  "datePublished": "2023-03-17T16:21:43+08:00",
  "dateModified": "2023-03-17T16:21:43+08:00",
  "author":[{
    "@type": "Person",
    "name": "hanson"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://hanson00.github.io/posts/technology/js%E9%80%86%E5%90%91/ast%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Hanson's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://hanson00.github.io/posts/imgs/66.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://hanson00.github.io/" accesskey="h" title="Hanson&#39;s Blog (Alt + H)">Hanson&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://hanson00.github.io/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://hanson00.github.io/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://hanson00.github.io/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://hanson00.github.io/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://hanson00.github.io/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://hanson00.github.io/about" title="🙋🏻‍♂️关于">
                    <span>🙋🏻‍♂️关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">

  <header class="post-header">
    <div class="breadcrumbs"><a href="https://hanson00.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://hanson00.github.io/posts/">Posts</a>&nbsp;»&nbsp;<a href="https://hanson00.github.io/posts/technology/">💻技术类文章</a></div>
    <h1 class="post-title">
      Ast混淆技术
    </h1>
    <div class="post-description">
      ast学习
    </div>
    <div class="post-meta">










更新:&nbsp;2023-03-17&nbsp;|&nbsp;字数:&nbsp;3100字&nbsp;|&nbsp;时长: 7分钟&nbsp;|&nbsp;
作者:&nbsp;hanson&nbsp;|&nbsp;标签: &nbsp;
      <ul class="post-tags-meta">
        <a href="https://hanson00.github.io/tags/js%E9%80%86%E5%90%91/">js逆向</a>
        <a href="https://hanson00.github.io/tags/%E7%88%AC%E8%99%AB/">、爬虫</a>
      </ul>

      <span id="busuanzi_container_page_pv">
        &nbsp;| 访问: <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
        <div class="toc">
            <details  open>
                <summary accesskey="c" title="(Alt + C)">
                    <span class="details">Table of Contents</span>
                </summary>

                <div class="inner"><ul>
                        <li>
                            <a href="#ast%e6%8a%80%e6%9c%af" aria-label="ast技术">ast技术</a><ul>
                                    
                        <li>
                            <a href="#ast%e7%9a%84%e5%ae%9a%e4%b9%89" aria-label="ast的定义">ast的定义</a></li>
                        <li>
                            <a href="#ast-%e7%9a%84%e7%94%a8%e9%80%94" aria-label="AST 的用途">AST 的用途</a></li>
                        <li>
                            <a href="#ast%e6%8f%92%e4%bb%b6%e7%9a%84%e8%b5%84%e6%ba%90" aria-label="AST插件的资源">AST插件的资源</a></li>
                        <li>
                            <a href="#%e8%a7%a3%e6%b7%b7%e6%b7%86api%e5%ad%a6%e4%b9%a0" aria-label="解混淆API学习">解混淆API学习</a><ul>
                                    
                        <li>
                            <a href="#%e5%90%84%e7%a7%8d%e5%b8%b8%e8%a7%81%e7%9a%84%e8%8a%82%e7%82%b9%e7%b1%bb%e5%9e%8b" aria-label="各种常见的节点类型">各种常见的节点类型</a></li>
                        <li>
                            <a href="#fs%e5%ba%93%e5%8f%af%e4%bb%a5%e8%a7%a3%e5%86%b3js%e7%9a%84%e6%96%87%e4%bb%b6%e8%af%bb%e5%86%99%e9%97%ae%e9%a2%98" aria-label="fs库可以解决js的文件读写问题">fs库可以解决js的文件读写问题</a></li>
                        <li>
                            <a href="#%e5%ae%89%e8%a3%85babel%e5%ba%93" aria-label="安装babel库">安装babel库</a></li>
                        <li>
                            <a href="#%e5%b0%8f%e8%af%95%e7%89%9b%e5%88%80" aria-label="小试牛刀">小试牛刀</a><ul>
                                    
                        <li>
                            <a href="#parser%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="parser的使用">parser的使用</a></li>
                        <li>
                            <a href="#traverse%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="traverse的使用">traverse的使用</a><ul>
                                    
                        <li>
                            <a href="#path%e7%9a%84%e5%b1%9e%e6%80%a7" aria-label="path的属性">path的属性</a></li>
                        <li>
                            <a href="#path%e6%96%b9%e6%b3%95" aria-label="path方法">path方法</a></li></ul>
                        </li>
                        <li>
                            <a href="#fs%e5%af%bc%e5%87%ba%e4%b8%8e%e8%af%bb%e5%8f%96%e6%96%87%e4%bb%b6" aria-label="fs导出与读取文件">fs导出与读取文件</a>
                        </li>
                    </ul>
                    </li>
                    </ul>
                    </li>
                    </ul>
                    </li>
                    </ul>
                </div>
            </details>
        </div>
    </aside>
    <script>
        let activeElement;
        let elements;
        window.addEventListener('DOMContentLoaded', function (event) {
            checkTocPosition();

            elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }, false);

        window.addEventListener('resize', function (event) {
            checkTocPosition();
        }, false);

        window.addEventListener('scroll', () => {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                    (getOffsetTop(element) - window.pageYOffset) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement

            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                if (element === activeElement) {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
                } else {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
                }
            })
        }, false);

        const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
        const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
        const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

        function checkTocPosition() {
            const width = document.body.scrollWidth;

            if (width - main - (toc * 2) - (gap * 4) > 0) {
                document.getElementById("toc-container").classList.add("wide");
            } else {
                document.getElementById("toc-container").classList.remove("wide");
            }
        }

        function getOffsetTop(element) {
            if (!element.getClientRects().length) {
                return 0;
            }
            let rect = element.getBoundingClientRect();
            let win = element.ownerDocument.defaultView;
            return rect.top + win.pageYOffset;
        }
    </script>
  <div class="post-content"><h1 id="ast技术">ast技术<a hidden class="anchor" aria-hidden="true" href="#ast技术">#</a></h1>
<p>ast技术对爬虫工程师来说只是一种辅助工具，并不能帮我们找到核心的代码，但能够提高我们扣混淆js的效率，提高代码可读性。</p>
<p>在编译原理中，编译器转换代码通常要经过三个步骤：词法分析（Lexical Analysis）、语法分析（Syntax Analysis）、代码生成（Code Generation）</p>
<p>学习ast主要就是判断节点，写条件，还原代码</p>
<h2 id="ast的定义">ast的定义<a hidden class="anchor" aria-hidden="true" href="#ast的定义">#</a></h2>
<p>ast(Absctact Syntax Tree)，译为抽象语法树。为源代码的抽象语法结构的树状表示，树上的每个节点都表示源代码中的一种结构，这种数据结构可以类别为一个大的<code>JSON</code>对象。通过 <code>AST</code> 技术，我们面对的就不再是各种符号混杂空格而成的文本字符串，而是一个严谨规范的树形结构，我们可以通过对 <code>AST </code>树节点的一系列操作，借助机器高效且精准地修改代码。</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">下面两段js代码等价，相当于从&#39;sm-crypto&#39;中读取sm2模块
const sm2 = require(&#39;sm-crypto&#39;).sm2
const {sm2} = require(&#39;sm-crypto&#39;)
</code></pre></td></tr></table>
</div>
</div><h2 id="ast-的用途">AST 的用途<a hidden class="anchor" aria-hidden="true" href="#ast-的用途">#</a></h2>
<p>IDE 的语法高亮、代码检查、格式化、压缩、转译等。将 ES6转化成ES5实现语法兼容</p>
<h2 id="ast插件的资源">AST插件的资源<a hidden class="anchor" aria-hidden="true" href="#ast插件的资源">#</a></h2>
<ol>
<li>
<p>Astexplorer.net：一个在线的AST浏览器和编辑器，可以帮助你快速创建和调试AST插件。</p>
</li>
<li>
<p>Esprima和Babel：这两个工具是用于JavaScript的解析器和转译器，可以帮助你构建JavaScript AST插件。</p>
</li>
<li>
<p>Python的ast模块：Python内置的ast模块提供了一组工具来处理Python代码的AST，可以帮助你构建Python AST插件。</p>
</li>
<li>
<p>LLVM：一个开源的编译器基础设施，提供了许多库和工具来处理AST和IR，可以帮助你构建C++等语言的AST插件。</p>
</li>
<li>
<p>学习ast参考地址：https://evilrecluse.top/Babel-traverse-api-doc/#/</p>
</li>
</ol>
<h2 id="解混淆api学习">解混淆API学习<a hidden class="anchor" aria-hidden="true" href="#解混淆api学习">#</a></h2>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#2c5dcd;font-weight:bold">var</span> a <span style="color:#2c5dcd">=</span> <span style="color:#0c6">&#34;\u0068\u0065\u006c\u006c\u006f\u002c\u0041\u0053\u0054&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>1. type:  表示当前节点的类型，我们常用的类型判断方法 t.is *<em>*</em>**(node),就是判断当前的节点是否为某个类型。</strong></p>
<p><strong>2. start: 表示当前节点的起始位。</strong></p>
<p><strong>3. end:  表示当前节点的末尾。</strong></p>
<p><strong>4. loc :  表示当前节点所在的行列位置，里面也有start与end节点，这里的start与上面的start是不同的，这里的start是表示节点所在起始的行列位。置，而end表示的是节点所在末尾的行列位置。</strong></p>
<p><strong>5. errors:是File节点所特有的属性，可以不用理会。</strong></p>
<p><strong>6. program:包含整个源代码，不包含注释节点。</strong></p>
<p><strong>7. comments:源代码中所有的注释会在这里显示。</strong></p>
<h3 id="各种常见的节点类型">各种常见的节点类型<a hidden class="anchor" aria-hidden="true" href="#各种常见的节点类型">#</a></h3>
<p><img loading="lazy" src="https://cdn.staticaly.com/gh/hanson00/img@master/ast01.png" alt="image-20230318072614156"  />
</p>
<h3 id="fs库可以解决js的文件读写问题">fs库可以解决js的文件读写问题<a hidden class="anchor" aria-hidden="true" href="#fs库可以解决js的文件读写问题">#</a></h3>
<p>读取文件</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">xx <span style="color:#2c5dcd">=</span> _fs.readFileSync(<span style="color:#0c6">&#39;test.js&#39;</span>,{encoding<span style="color:#2c5dcd">:</span><span style="color:#0c6">&#39;utf-8&#39;</span>})
</code></pre></td></tr></table>
</div>
</div><p>写入文件</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">fs.writeFile(<span style="color:#0c6">&#39;decode.js&#39;</span>, code, (err)=&gt;{});
</code></pre></td></tr></table>
</div>
</div><h3 id="安装babel库">安装babel库<a hidden class="anchor" aria-hidden="true" href="#安装babel库">#</a></h3>
<ol>
<li><code>@babel/core</code>：Babel 编译器本身，提供了 babel 的编译 API；</li>
<li><code>@babel/parser</code>：将 JavaScript 代码<strong>解析成 AST 语法树</strong>；</li>
<li><code>@babel/traverse</code>：<strong>遍历、修改</strong> AST 语法树的<strong>各个节点</strong>；</li>
<li><code>@babel/generator</code>：将 AST <strong>还原成 JavaScript 代码</strong>；</li>
<li><code>@babel/types</code>：<strong>判断、验证节点的类型</strong>、构建新 AST 节点等。</li>
</ol>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">npm install <span style="color:#fff;background-color:#c00">@</span>babel<span style="color:#2c5dcd">/</span>core <span style="color:#2c5dcd">--</span>save<span style="color:#2c5dcd">-</span>dev
</code></pre></td></tr></table>
</div>
</div><h3 id="小试牛刀">小试牛刀<a hidden class="anchor" aria-hidden="true" href="#小试牛刀">#</a></h3>
<h4 id="parser的使用">parser的使用<a hidden class="anchor" aria-hidden="true" href="#parser的使用">#</a></h4>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#2c5dcd;font-weight:bold">const</span> parse <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;@babel/parser&#39;</span>)

js_code <span style="color:#2c5dcd">=</span> <span style="color:#0c6">`var a = &#34;\u0068\u0065\u006c\u006c\u006f\u002c\u0041\u0053\u0054&#34;`</span>

<span style="color:#2c5dcd;font-weight:bold">let</span> astTree <span style="color:#2c5dcd">=</span> parse.parse(js_code)
console.log(JSON.stringify(astTree, <span style="color:#2c5dcd;font-weight:bold">null</span>, <span style="color:#0c6">&#39;\t&#39;</span>))
</code></pre></td></tr></table>
</div>
</div><p>输出结果如下：</p>
<p>和ast解混淆网站输出的结果相同</p>
<p><img loading="lazy" src="https://cdn.staticaly.com/gh/hanson00/img@master/ast02.png" alt="image-20230318074226276"  />
</p>
<p><img loading="lazy" src="https://cdn.staticaly.com/gh/hanson00/img@master/ast03.png" alt="image-20230318074246668"  />
</p>
<p><img loading="lazy" src="https://cdn.staticaly.com/gh/hanson00/img@master/ast04.png" alt="image-20230318074307354"  />
</p>
<h4 id="traverse的使用">traverse的使用<a hidden class="anchor" aria-hidden="true" href="#traverse的使用">#</a></h4>
<p>traverse负责编写插件还原JavaScript</p>
<h5 id="path的属性">path的属性<a hidden class="anchor" aria-hidden="true" href="#path的属性">#</a></h5>
<p><code>path.node</code>:表示当前path下的node节点</p>
<p><code>path.toString()</code>:当前路径所对应的源代码</p>
<p><code>path.parentPath</code>:用于获取当前path下的父path，多用于判断节点类型</p>
<p><code>path.container</code>:用于获取当前path下的所有兄弟节点(包括自身)</p>
<p><code>path.type</code>:获取当前节点类型</p>
<p><code>path.get('')</code>:获取path的子路径</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#2c5dcd;font-weight:bold">const</span> parse <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;@babel/parser&#39;</span>)
<span style="color:#0080ff;font-style:italic">//负责编写解混淆插件
</span><span style="color:#0080ff;font-style:italic"></span><span style="color:#2c5dcd;font-weight:bold">const</span> traverse <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;@babel/traverse&#39;</span>).<span style="color:#2c5dcd;font-weight:bold">default</span>
<span style="color:#2c5dcd;font-weight:bold">const</span> generator <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;@babel/generator&#39;</span>).<span style="color:#2c5dcd;font-weight:bold">default</span>

js_code <span style="color:#2c5dcd">=</span> <span style="color:#0c6">`var a = &#34;\u0068\u0065\u006c\u006c\u006f\u002c\u0041\u0053\u0054&#34;`</span>
<span style="color:#2c5dcd;font-weight:bold">let</span> astTree <span style="color:#2c5dcd">=</span> parse.parse(js_code)

<span style="color:#0080ff;font-style:italic">// 编写插件，还原JavaScript
</span><span style="color:#0080ff;font-style:italic">// traverse(astTree, {
</span><span style="color:#0080ff;font-style:italic">//     VariableDeclaration(path){
</span><span style="color:#0080ff;font-style:italic">//         //  path.node  表示当前节点
</span><span style="color:#0080ff;font-style:italic">//         console.log(path.node)
</span><span style="color:#0080ff;font-style:italic">//
</span><span style="color:#0080ff;font-style:italic">//         // path.type 获取当前节点的类型
</span><span style="color:#0080ff;font-style:italic">//         // console.log(path.type)
</span><span style="color:#0080ff;font-style:italic">//
</span><span style="color:#0080ff;font-style:italic">//         //path.toString() 获取源代码
</span><span style="color:#0080ff;font-style:italic">//         console.log(path.toString())
</span><span style="color:#0080ff;font-style:italic">//
</span><span style="color:#0080ff;font-style:italic">//         //下面两个语句作用相同
</span><span style="color:#0080ff;font-style:italic">//         console.log(path.parent)
</span><span style="color:#0080ff;font-style:italic">//         // console.log(path.parentPath.node)
</span><span style="color:#0080ff;font-style:italic">//         // console.log(&#39;-------------------------------&#39;)
</span><span style="color:#0080ff;font-style:italic">//         // .get()找下一个节点
</span><span style="color:#0080ff;font-style:italic">//         // console.log(path.get(&#39;declarations&#39;)
</span><span style="color:#0080ff;font-style:italic">//     }
</span><span style="color:#0080ff;font-style:italic">// })
</span><span style="color:#0080ff;font-style:italic"></span>
<span style="color:#0080ff;font-style:italic">//处理编码
</span><span style="color:#0080ff;font-style:italic"></span>plug <span style="color:#2c5dcd">=</span> {
    StringLiteral(path){
        path.node.extra.raw <span style="color:#2c5dcd">=</span> path.node.extra.rawValue
    }
}
traverse(astTree, plug)

<span style="color:#0080ff;font-style:italic">// traverse(astTree, {
</span><span style="color:#0080ff;font-style:italic">//     Identifier(path){
</span><span style="color:#0080ff;font-style:italic">//         console.log(path.node.name)
</span><span style="color:#0080ff;font-style:italic">//     }
</span><span style="color:#0080ff;font-style:italic">// })
</span><span style="color:#0080ff;font-style:italic">//
</span><span style="color:#0080ff;font-style:italic">// traverse(astTree, {
</span><span style="color:#0080ff;font-style:italic">//     StringLiteral(path){
</span><span style="color:#0080ff;font-style:italic">//         console.log(path.node.value)
</span><span style="color:#0080ff;font-style:italic">//
</span><span style="color:#0080ff;font-style:italic">//     }
</span><span style="color:#0080ff;font-style:italic">// })
</span><span style="color:#0080ff;font-style:italic"></span>
<span style="color:#2c5dcd;font-weight:bold">let</span> {code} <span style="color:#2c5dcd">=</span> generator(astTree)
console.log(code)
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#2c5dcd;font-weight:bold">const</span> parse <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;@babel/parser&#39;</span>)
<span style="color:#2c5dcd;font-weight:bold">const</span> traverse <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;@babel/traverse&#39;</span>).<span style="color:#2c5dcd;font-weight:bold">default</span>
<span style="color:#2c5dcd;font-weight:bold">const</span> generator <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;@babel/generator&#39;</span>).<span style="color:#2c5dcd;font-weight:bold">default</span>
js_code <span style="color:#2c5dcd">=</span> <span style="color:#0c6">`var a = &#34;\u0068\u0065\u006c\u006c\u006f\u002c\u0041\u0053\u0054&#34;`</span>
<span style="color:#2c5dcd;font-weight:bold">let</span> astTree <span style="color:#2c5dcd">=</span> parse.parse(js_code)


<span style="color:#2c5dcd;font-weight:bold">let</span> code1 <span style="color:#2c5dcd">=</span> generator(astTree)
console.log(code1)

<span style="color:#0080ff;font-style:italic">// `@babel/generator`：将 AST 还原成 JavaScript 代码
</span><span style="color:#0080ff;font-style:italic">// {code}是从还原的代码中获取JavaScript源代码，运行代码可以自己看看
</span><span style="color:#0080ff;font-style:italic"></span><span style="color:#2c5dcd;font-weight:bold">let</span> {code} <span style="color:#2c5dcd">=</span> generator(astTree)
console.log(<span style="color:#0c6">&#39;-------------------&#39;</span>)
console.log(code)
</code></pre></td></tr></table>
</div>
</div><h5 id="path方法">path方法<a hidden class="anchor" aria-hidden="true" href="#path方法">#</a></h5>
<p><code>path.replaceWith</code>:(单)节点替换函数</p>
<p><code>replaceWithMultiple </code>多节点替换函数，调用方式:</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">path.replaceWithMultiple(ArrayNode);
</code></pre></td></tr></table>
</div>
</div><p><code>replaceWithMultiple</code> 方法需要传入一个节点数组作为参数，这个数组中的节点会被替换当前的节点。这些新节点可以是任何合法的 AST 节点，例如表达式、语句、声明等</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">path.replaceWith(newNode);
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#2c5dcd">!</span>(<span style="color:#2c5dcd;font-weight:bold">function</span> () {
    console.log(<span style="color:#0c6">&#39;66666&#39;</span>)
})
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#0080ff;font-style:italic">// 还原函数
</span><span style="color:#0080ff;font-style:italic"></span>traverse(astTree, {
    UnaryExpression(path) {
        <span style="color:#2c5dcd;font-weight:bold">let</span> {argument} <span style="color:#2c5dcd">=</span> path.node
        <span style="color:#2c5dcd;font-weight:bold">if</span> (<span style="color:#2c5dcd">!</span>types.isFunctionExpression(argument)) {
            <span style="color:#2c5dcd;font-weight:bold">return</span>
        }
        <span style="color:#2c5dcd;font-weight:bold">let</span> {body, id, params} <span style="color:#2c5dcd">=</span> argument
        <span style="color:#2c5dcd;font-weight:bold">if</span> (id <span style="color:#2c5dcd">!=</span> <span style="color:#2c5dcd;font-weight:bold">null</span> <span style="color:#2c5dcd">||</span> params.length <span style="color:#2c5dcd">!=</span> <span style="color:#5918bb;font-weight:bold">0</span>) {
            <span style="color:#2c5dcd;font-weight:bold">return</span>
        }
        <span style="color:#0080ff;font-style:italic">//`replaceWithMultiple `多节点替换函数，调用方式:
</span><span style="color:#0080ff;font-style:italic"></span>        path.replaceWithMultiple(body.body);
    }
})
</code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cdn.staticaly.com/gh/hanson00/img@master/202303210737237.png" alt="image-20230321073732082"  />
</p>
<p><strong>evaluate()方法学习</strong></p>
<p>针对作用域和引用，直接依据引用来计算出执行结果。</p>
<p>例子：<code>navigator[&quot;\x75\x73&quot;+&quot;\x65\x72&quot;+&quot;\x41\x67&quot;+&quot;\x65\x6e&quot;+&quot;\x74&quot;]</code></p>
<p>例子2：</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#2c5dcd;font-weight:bold">function</span> _xl(){
	x <span style="color:#2c5dcd">=</span> <span style="color:#5918bb;font-weight:bold">1</span> <span style="color:#2c5dcd">+</span> <span style="color:#5918bb;font-weight:bold">2</span> <span style="color:#2c5dcd">+</span> <span style="color:#5918bb;font-weight:bold">3</span> <span style="color:#2c5dcd">+</span><span style="color:#5918bb;font-weight:bold">4</span> <span style="color:#2c5dcd">+</span> <span style="color:#5918bb;font-weight:bold">5</span> <span style="color:#2c5dcd">+</span> <span style="color:#5918bb;font-weight:bold">6</span> <span style="color:#2c5dcd">+</span> <span style="color:#5918bb;font-weight:bold">7</span>
}
</code></pre></td></tr></table>
</div>
</div><p>插件编写</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">visitor2 <span style="color:#2c5dcd">=</span> {
    <span style="color:#0c6">&#34;BinaryExpression|Identifier&#34;</span>(path){
        <span style="color:#2c5dcd;font-weight:bold">const</span> {confident,value} <span style="color:#2c5dcd">=</span> path.evaluate();
        confident <span style="color:#2c5dcd">&amp;&amp;</span> path.replaceInline(types.valueToNode(value))
    }
}
traverse(_ast,visitor2)
</code></pre></td></tr></table>
</div>
</div><p><strong>编码类型还原</strong></p>
<p>处理前:</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#2c5dcd;font-weight:bold">var</span> a <span style="color:#2c5dcd">=</span> <span style="color:#5918bb;font-weight:bold">0x25</span>,b <span style="color:#2c5dcd">=</span> <span style="color:#5918bb;font-weight:bold">0b10001001</span>,c <span style="color:#2c5dcd">=</span> <span style="color:#5918bb;font-weight:bold">0o123456</span>,
d <span style="color:#2c5dcd">=</span> <span style="color:#0c6">&#34;\x68\x65\x6c\x6c\x6f\x2c\x41\x53\x54&#34;</span>,
e <span style="color:#2c5dcd">=</span> <span style="color:#0c6">&#34;\u0068\u0065\u006c\u006c\u006f\u002c\u0041\u0053\u0054&#34;</span>;
</code></pre></td></tr></table>
</div>
</div><p>处理后:</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#2c5dcd;font-weight:bold">var</span> a <span style="color:#2c5dcd">=</span> <span style="color:#5918bb;font-weight:bold">37</span>,b <span style="color:#2c5dcd">=</span> <span style="color:#5918bb;font-weight:bold">137</span>,c <span style="color:#2c5dcd">=</span> <span style="color:#5918bb;font-weight:bold">42798</span>,d <span style="color:#2c5dcd">=</span> <span style="color:#0c6">&#34;hello,AST&#34;</span>,e <span style="color:#2c5dcd">=</span> <span style="color:#0c6">&#34;hello,AST&#34;</span>;
</code></pre></td></tr></table>
</div>
</div><p>插件编写:</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#2c5dcd;font-weight:bold">const</span> transform_literal <span style="color:#2c5dcd">=</span> {
  NumericLiteral({node}) {
    <span style="color:#2c5dcd;font-weight:bold">if</span> (node.extra <span style="color:#2c5dcd">&amp;&amp;</span> <span style="color:#0c6">/^0[obx]/i</span>.test(node.extra.raw)) {
      node.extra <span style="color:#2c5dcd">=</span> <span style="color:#2c5dcd;font-weight:bold">undefined</span>;
    }
  },
  StringLiteral({node}) 
  {
    <span style="color:#2c5dcd;font-weight:bold">if</span> (node.extra <span style="color:#2c5dcd">&amp;&amp;</span> <span style="color:#0c6">/\\[ux]/gi</span>.test(node.extra.raw)) {
      node.extra <span style="color:#2c5dcd">=</span> <span style="color:#2c5dcd;font-weight:bold">undefined</span>;
    }
  },
}
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>通用插件</p>
</blockquote>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#2c5dcd;font-weight:bold">const</span> constantFold <span style="color:#2c5dcd">=</span> {
    <span style="color:#0c6">&#34;BinaryExpression|UnaryExpression|ConditionalExpression&#34;</span>(path) {
        <span style="color:#0080ff;font-style:italic">// 防止溢出
</span><span style="color:#0080ff;font-style:italic"></span>        <span style="color:#2c5dcd;font-weight:bold">if</span>(path.isUnaryExpression({operator<span style="color:#2c5dcd">:</span><span style="color:#0c6">&#34;-&#34;</span>}) <span style="color:#2c5dcd">||</span>
    	   path.isUnaryExpression({operator<span style="color:#2c5dcd">:</span><span style="color:#0c6">&#34;void&#34;</span>}))
    	{
    		<span style="color:#2c5dcd;font-weight:bold">return</span>;
    	}
        <span style="color:#2c5dcd;font-weight:bold">const</span> {confident, value} <span style="color:#2c5dcd">=</span> path.evaluate();
        <span style="color:#2c5dcd;font-weight:bold">if</span> (<span style="color:#2c5dcd">!</span>confident)
            <span style="color:#2c5dcd;font-weight:bold">return</span>;
        <span style="color:#2c5dcd;font-weight:bold">if</span> (<span style="color:#2c5dcd;font-weight:bold">typeof</span> value <span style="color:#2c5dcd">==</span> <span style="color:#0c6">&#39;number&#39;</span> <span style="color:#2c5dcd">&amp;&amp;</span> (<span style="color:#2c5dcd">!</span><span style="color:#5918bb;font-weight:bold">Number</span>.<span style="color:#5918bb;font-weight:bold">isFinite</span>(value))) {
            <span style="color:#2c5dcd;font-weight:bold">return</span>;
        }
        path.replaceWith(types.valueToNode(value));
    },
}
traverse(_ast, constantFold);
</code></pre></td></tr></table>
</div>
</div><h4 id="fs导出与读取文件">fs导出与读取文件<a hidden class="anchor" aria-hidden="true" href="#fs导出与读取文件">#</a></h4>
<p>读取文件</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">gy <span style="color:#2c5dcd">=</span> _fs.readFileSync(<span style="color:#0c6">&#39;test.js&#39;</span>,{encoding<span style="color:#2c5dcd">:</span><span style="color:#0c6">&#39;utf-8&#39;</span>})
</code></pre></td></tr></table>
</div>
</div><p>写入文件</p>
<div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">fs.writeFile(<span style="color:#0c6">&#39;decode.js&#39;</span>, code, (err)=&gt;{});
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#2c5dcd;font-weight:bold">const</span> parse <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;@babel/parser&#39;</span>)
<span style="color:#2c5dcd;font-weight:bold">const</span> traverse <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;@babel/traverse&#39;</span>).<span style="color:#2c5dcd;font-weight:bold">default</span>
<span style="color:#2c5dcd;font-weight:bold">const</span> generator <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;@babel/generator&#39;</span>).<span style="color:#2c5dcd;font-weight:bold">default</span>
<span style="color:#2c5dcd;font-weight:bold">const</span> fs <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;fs&#39;</span>)
<span style="color:#2c5dcd;font-weight:bold">const</span> types <span style="color:#2c5dcd">=</span> require(<span style="color:#0c6">&#39;@babel/types&#39;</span>)


js_code <span style="color:#2c5dcd">=</span> fs.readFileSync(<span style="color:#0c6">&#39;encode.js&#39;</span>, {encoding<span style="color:#2c5dcd">:</span> <span style="color:#0c6">&#39;utf-8&#39;</span>})
<span style="color:#2c5dcd;font-weight:bold">let</span> astTree <span style="color:#2c5dcd">=</span> parse.parse(js_code)

<span style="color:#0080ff;font-style:italic">// 处理编码
</span><span style="color:#0080ff;font-style:italic">// 变量赋值还原
</span><span style="color:#0080ff;font-style:italic"></span>traverse(astTree, {
    <span style="color:#0080ff;font-style:italic">// 变量赋值还原
</span><span style="color:#0080ff;font-style:italic"></span>    StringLiteral(path) {
        path.node.extra.raw <span style="color:#2c5dcd">=</span> path.node.rawValue
    }
})

<span style="color:#0080ff;font-style:italic">// + 拼接还原
</span><span style="color:#0080ff;font-style:italic"></span>traverse(astTree, {
    <span style="color:#0080ff;font-style:italic">// + 拼接还原
</span><span style="color:#0080ff;font-style:italic"></span>    BinaryExpression(path) {
        <span style="color:#2c5dcd;font-weight:bold">let</span> {left, operator, right} <span style="color:#2c5dcd">=</span> path.node;
        <span style="color:#0080ff;font-style:italic">// console.log(left)
</span><span style="color:#0080ff;font-style:italic"></span>        <span style="color:#0080ff;font-style:italic">// console.log(left.value)
</span><span style="color:#0080ff;font-style:italic"></span>        <span style="color:#2c5dcd;font-weight:bold">if</span> (types.isNumericLiteral(left) <span style="color:#2c5dcd">&amp;&amp;</span> types.isNumericLiteral(right) <span style="color:#2c5dcd">&amp;&amp;</span> operator <span style="color:#2c5dcd">==</span> <span style="color:#0c6">&#34;+&#34;</span>) {
            value <span style="color:#2c5dcd">=</span> left.value <span style="color:#2c5dcd">+</span> right.value

            path.replaceWith(types.valueToNode(value))  <span style="color:#0080ff;font-style:italic">// 进行方法替换
</span><span style="color:#0080ff;font-style:italic"></span>        }

        <span style="color:#2c5dcd;font-weight:bold">if</span> (types.isStringLiteral(left) <span style="color:#2c5dcd">&amp;&amp;</span> types.isStringLiteral(right) <span style="color:#2c5dcd">&amp;&amp;</span> operator <span style="color:#2c5dcd">==</span> <span style="color:#0c6">&#39;+&#39;</span>) {
            <span style="color:#2c5dcd;font-weight:bold">let</span> value <span style="color:#2c5dcd">=</span> left.value <span style="color:#2c5dcd">+</span> right.value
            path.replaceWith(types.valueToNode(value))
        }
    }
})

<span style="color:#0080ff;font-style:italic">// 还原函数
</span><span style="color:#0080ff;font-style:italic"></span>traverse(astTree, {
    UnaryExpression(path) {
        <span style="color:#2c5dcd;font-weight:bold">let</span> {argument} <span style="color:#2c5dcd">=</span> path.node
        <span style="color:#2c5dcd;font-weight:bold">if</span> (<span style="color:#2c5dcd">!</span>types.isFunctionExpression(argument)) {
            <span style="color:#2c5dcd;font-weight:bold">return</span>
        }
        <span style="color:#2c5dcd;font-weight:bold">let</span> {body, id, params} <span style="color:#2c5dcd">=</span> argument
        <span style="color:#2c5dcd;font-weight:bold">if</span> (id <span style="color:#2c5dcd">!=</span> <span style="color:#2c5dcd;font-weight:bold">null</span> <span style="color:#2c5dcd">||</span> params.length <span style="color:#2c5dcd">!=</span> <span style="color:#5918bb;font-weight:bold">0</span>) {
            <span style="color:#2c5dcd;font-weight:bold">return</span>
        }
        <span style="color:#0080ff;font-style:italic">//`replaceWithMultiple `多节点替换函数，调用方式:
</span><span style="color:#0080ff;font-style:italic"></span>        path.replaceWithMultiple(body.body);
    }
})

<span style="color:#0080ff;font-style:italic">// 还原带括号的自执行方法
</span><span style="color:#0080ff;font-style:italic"></span>traverse(astTree, {
    UnaryExpression(path) {
        <span style="color:#2c5dcd;font-weight:bold">let</span> {argument} <span style="color:#2c5dcd">=</span> path.node
        <span style="color:#0080ff;font-style:italic">// console.log(argument)
</span><span style="color:#0080ff;font-style:italic"></span>        <span style="color:#2c5dcd;font-weight:bold">if</span> (<span style="color:#2c5dcd">!</span>types.isCallExpression(argument)) {
            <span style="color:#2c5dcd;font-weight:bold">return</span>
        }
        <span style="color:#0080ff;font-style:italic">// console.log(argument.callee)
</span><span style="color:#0080ff;font-style:italic"></span>        <span style="color:#2c5dcd;font-weight:bold">let</span> {body, id, params} <span style="color:#2c5dcd">=</span> argument.callee
        <span style="color:#2c5dcd;font-weight:bold">if</span> (id <span style="color:#2c5dcd">!=</span> <span style="color:#2c5dcd;font-weight:bold">null</span> <span style="color:#2c5dcd">||</span> params.length <span style="color:#2c5dcd">!=</span> <span style="color:#5918bb;font-weight:bold">0</span>) {
            <span style="color:#2c5dcd;font-weight:bold">return</span>
        }
        <span style="color:#0080ff;font-style:italic">//`replaceWithMultiple `多节点替换函数，调用方式:
</span><span style="color:#0080ff;font-style:italic"></span>        path.replaceWithMultiple(body.body);
    }
})

<span style="color:#0080ff;font-style:italic">// 还原var arr =  &#39;3,4,0,5,1,2&#39;[&#39;split&#39;](&#39;,&#39;)代码有问题
</span><span style="color:#0080ff;font-style:italic">// traverse(astTree, {
</span><span style="color:#0080ff;font-style:italic">//     CallExpression(path){
</span><span style="color:#0080ff;font-style:italic">//         let {callee,arguments} = path.node
</span><span style="color:#0080ff;font-style:italic">//         // object是列表的值
</span><span style="color:#0080ff;font-style:italic">//         let object = callee.object.value;
</span><span style="color:#0080ff;font-style:italic">//         // console.log(object)
</span><span style="color:#0080ff;font-style:italic">//
</span><span style="color:#0080ff;font-style:italic">//         //property是方法split
</span><span style="color:#0080ff;font-style:italic">//         let property = callee.property.value;
</span><span style="color:#0080ff;font-style:italic">//         // console.log(property)
</span><span style="color:#0080ff;font-style:italic">//         // 逗号
</span><span style="color:#0080ff;font-style:italic">//         let argument = arguments[0].value;
</span><span style="color:#0080ff;font-style:italic">//         // console.log(argument)
</span><span style="color:#0080ff;font-style:italic">//
</span><span style="color:#0080ff;font-style:italic">//          //模拟执行方法
</span><span style="color:#0080ff;font-style:italic">//          array = property[object](argument)
</span><span style="color:#0080ff;font-style:italic">//          path.replaceWithMultiple(types.valueToNode(array))
</span><span style="color:#0080ff;font-style:italic">//     }
</span><span style="color:#0080ff;font-style:italic">// })
</span><span style="color:#0080ff;font-style:italic"></span>
<span style="color:#0080ff;font-style:italic">// 计算结果拼接 针对作用域和引用，直接依据引用来计算出执行结果。
</span><span style="color:#0080ff;font-style:italic"></span>traverse(astTree, {
     <span style="color:#0c6">&#34;BinaryExpression|Identifier&#34;</span>(path){
        <span style="color:#2c5dcd;font-weight:bold">const</span> {confident,value} <span style="color:#2c5dcd">=</span> path.evaluate();
        confident <span style="color:#2c5dcd">&amp;&amp;</span> path.replaceInline(types.valueToNode(value))
    }
})


<span style="color:#0080ff;font-style:italic">//通用插件
</span><span style="color:#0080ff;font-style:italic"></span><span style="color:#2c5dcd;font-weight:bold">const</span> constantFold <span style="color:#2c5dcd">=</span> {
    <span style="color:#0c6">&#34;BinaryExpression|UnaryExpression|ConditionalExpression&#34;</span>(path) {
        <span style="color:#0080ff;font-style:italic">// 防止溢出
</span><span style="color:#0080ff;font-style:italic"></span>        <span style="color:#2c5dcd;font-weight:bold">if</span>(path.isUnaryExpression({operator<span style="color:#2c5dcd">:</span><span style="color:#0c6">&#34;-&#34;</span>}) <span style="color:#2c5dcd">||</span>
          path.isUnaryExpression({operator<span style="color:#2c5dcd">:</span><span style="color:#0c6">&#34;void&#34;</span>}))
       {
          <span style="color:#2c5dcd;font-weight:bold">return</span>;
       }
        <span style="color:#2c5dcd;font-weight:bold">const</span> {confident, value} <span style="color:#2c5dcd">=</span> path.evaluate();
        <span style="color:#2c5dcd;font-weight:bold">if</span> (<span style="color:#2c5dcd">!</span>confident)
            <span style="color:#2c5dcd;font-weight:bold">return</span>;
        <span style="color:#2c5dcd;font-weight:bold">if</span> (<span style="color:#2c5dcd;font-weight:bold">typeof</span> value <span style="color:#2c5dcd">==</span> <span style="color:#0c6">&#39;number&#39;</span> <span style="color:#2c5dcd">&amp;&amp;</span> (<span style="color:#2c5dcd">!</span><span style="color:#5918bb;font-weight:bold">Number</span>.<span style="color:#5918bb;font-weight:bold">isFinite</span>(value))) {
            <span style="color:#2c5dcd;font-weight:bold">return</span>;
        }
        path.replaceWith(types.valueToNode(value));
    },
}
traverse(astTree, constantFold);

<span style="color:#0080ff;font-style:italic">// 编码类型还原，处理编码和进制插件
</span><span style="color:#0080ff;font-style:italic"></span><span style="color:#2c5dcd;font-weight:bold">const</span> transform_literal <span style="color:#2c5dcd">=</span> {
  NumericLiteral({node}) {
    <span style="color:#2c5dcd;font-weight:bold">if</span> (node.extra <span style="color:#2c5dcd">&amp;&amp;</span> <span style="color:#0c6">/^0[obx]/i</span>.test(node.extra.raw)) {
      node.extra <span style="color:#2c5dcd">=</span> <span style="color:#2c5dcd;font-weight:bold">undefined</span>;
    }
  },
  StringLiteral({node})
  {
    <span style="color:#2c5dcd;font-weight:bold">if</span> (node.extra <span style="color:#2c5dcd">&amp;&amp;</span> <span style="color:#0c6">/\\[ux]/gi</span>.test(node.extra.raw)) {
      node.extra <span style="color:#2c5dcd">=</span> <span style="color:#2c5dcd;font-weight:bold">undefined</span>;
    }
  },
}
traverse(astTree, transform_literal);

<span style="color:#2c5dcd;font-weight:bold">let</span> {code} <span style="color:#2c5dcd">=</span> generator(astTree)
console.log(<span style="color:#0c6">&#39;--------------------------&#39;</span>)
console.log(code)

fs.writeFile(<span style="color:#0c6">&#39;decode.js&#39;</span>, code, (err) =&gt; {
});
</code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://hanson00.github.io/tags/js%E9%80%86%E5%90%91/">js逆向</a></li>
      <li><a href="https://hanson00.github.io/tags/%E7%88%AC%E8%99%AB/">爬虫</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://hanson00.github.io/posts/technology/js%E9%80%86%E5%90%91/%E8%A1%A5%E7%8E%AF%E5%A2%8301/">
    <span class="title">« Prev</span>
    <br>
    <span>补环境01</span>
  </a>
  <a class="next" href="https://hanson00.github.io/posts/technology/js%E9%80%86%E5%90%91/%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0rpc/">
    <span class="title">Next »</span>
    <br>
    <span>逆向学习RPC</span>
  </a>
</nav>

  </footer>
<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">💬评论</span>✨昵称输入QQ号可以自动关联✨
        <hr />

    </div>
    <div id="tcomment"></div>
    <script src="https://cdn.staticfile.org/twikoo/1.5.11/twikoo.all.min.js"></script>
    <script>
        twikoo.init({
            envId: "https://twikoo1-mu.vercel.app/",  
            el: "#tcomment",
            lang: 'zh-CN',
            region: 'ap-guangzhou',  
            path: window.TWIKOO_MAGIC_PATH || window.location.pathname,
        });
    </script>
</div>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://hanson00.github.io/">Hanson&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
